
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>WSL &#8212; Kolerov&#39;s Notes 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Tasks" href="../tasks/index.html" />
    <link rel="prev" title="Linux" href="linux.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../tasks/index.html" title="Tasks"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="linux.html" title="Linux"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Kolerov&#39;s Notes 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Environment</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">WSL</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="wsl">
<h1>WSL<a class="headerlink" href="#wsl" title="Permalink to this heading">¶</a></h1>
<section id="install-ubuntu">
<h2>Install Ubuntu<a class="headerlink" href="#install-ubuntu" title="Permalink to this heading">¶</a></h2>
<p>Install the latest Ubuntu:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>wsl --install -d Ubuntu
wsl --set-default-version 2
</pre></div>
</div>
</section>
<section id="install-fedora">
<h2>Install Fedora<a class="headerlink" href="#install-fedora" title="Permalink to this heading">¶</a></h2>
<p>Download an image from <a class="reference external" href="https://github.com/fedora-cloud/docker-brew-fedora/tree/37/x86_64">https://github.com/fedora-cloud/docker-brew-fedora/tree/37/x86_64</a>.
Unpack it to <code class="docutils literal notranslate"><span class="pre">fedora-37-x86_64.tar</span></code>. Place it to user’s home directory. Install it:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>mkdir $HOME\wsl\Fedora
wsl --import Fedora $HOME\wsl\Fedora $HOME\fedora-37-x86_64.tar
</pre></div>
</div>
<p>Install <cite>systemd</cite> and basic packages before any changes in <code class="docutils literal notranslate"><span class="pre">/etc/wsl.conf</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>dnf<span class="w"> </span>install<span class="w"> </span>systemd<span class="w"> </span>util-linux<span class="w"> </span>passwd
</pre></div>
</div>
<p>Add user:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>useradd<span class="w"> </span>-s<span class="w"> </span>/bin/bash<span class="w"> </span>-m<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;Yuriy Kolerov&quot;</span><span class="w"> </span>ykolerov
<span class="w">    </span>passwd<span class="w"> </span>ykolerov
</pre></div>
</div>
<p>Set this user as default in <code class="docutils literal notranslate"><span class="pre">/etc/wsl.conf</span></code>:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[user]</span>
<span class="n">default</span><span class="o">=</span><span class="n">ykolerov</span>
</pre></div>
</div>
</section>
<section id="install-wsl-vpnkit">
<h2>Install <code class="docutils literal notranslate"><span class="pre">wsl-vpnkit</span></code><a class="headerlink" href="#install-wsl-vpnkit" title="Permalink to this heading">¶</a></h2>
<p>Install <code class="docutils literal notranslate"><span class="pre">wsl-vpnkit</span></code> to avoid problems related to corporate VPN.
This tool may be found in <a class="reference external" href="https://github.com/sakai135/wsl-vpnkit">https://github.com/sakai135/wsl-vpnkit</a>.
Download the prebuilt file <code class="docutils literal notranslate"><span class="pre">wsl-vpnkit.tar.gz</span></code> from the latest release
and import the distro into WSL 2. Running the distro will show a short
intro and exit.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>wsl --import wsl-vpnkit --version 2 $env:USERPROFILE\wsl-vpnkit wsl-vpnkit.tar.gz
wsl -d wsl-vpnkit
</pre></div>
</div>
<p>Add the command to your <code class="docutils literal notranslate"><span class="pre">.profile</span></code> to start <code class="docutils literal notranslate"><span class="pre">wsl-vpnkit</span></code> when you
open the WSL terminal:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="k">$(</span>wsl.exe<span class="w"> </span>-d<span class="w"> </span>wsl-vpnkit<span class="w"> </span>--cd<span class="w"> </span>/app<span class="w"> </span>ps<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>wsl-vm<span class="k">)</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span>wsl.exe<span class="w"> </span>-d<span class="w"> </span>wsl-vpnkit<span class="w"> </span>--cd<span class="w"> </span>/app<span class="w"> </span>service<span class="w"> </span>wsl-vpnkit<span class="w"> </span>start
<span class="k">fi</span>
</pre></div>
</div>
</section>
<section id="configure-wsl">
<h2>Configure WSL<a class="headerlink" href="#configure-wsl" title="Permalink to this heading">¶</a></h2>
<p>Create <cite>.wslconfig</cite> in <cite>$USER</cite>:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[wsl2]</span>
<span class="n">memory</span><span class="o">=</span><span class="mi">8</span><span class="n">GB</span>
<span class="n">processors</span><span class="o">=</span><span class="mi">4</span>
</pre></div>
</div>
<p>Create <code class="docutils literal notranslate"><span class="pre">/etc/wsl.conf</span></code> on target:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[boot]</span>
<span class="n">systemd</span><span class="o">=</span><span class="kc">true</span>

<span class="k">[network]</span>
<span class="n">generateResolvConf</span><span class="o">=</span><span class="kc">false</span>
</pre></div>
</div>
<p>Reboot WSL and create <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>nameserver &lt;your-company-DNS&gt;
search &lt;you-company-internal-resource&gt;
nameserver 1.1.1.1
</pre></div>
</div>
</section>
<section id="build-and-install-the-linux-kernel-6-1">
<h2>Build and Install the Linux Kernel 6.1<a class="headerlink" href="#build-and-install-the-linux-kernel-6-1" title="Permalink to this heading">¶</a></h2>
<p>Dependencies for Ubuntu 22.04:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>build-essential<span class="w"> </span>flex<span class="w"> </span>bison<span class="w"> </span>libssl-dev<span class="w"> </span>libelf-dev<span class="w"> </span>git<span class="w"> </span>dwarves<span class="w"> </span>bc
</pre></div>
</div>
<p>Download and install the latest kernel:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/microsoft/WSL2-Linux-Kernel.git
<span class="nb">cd</span><span class="w"> </span>WSL2-Linux-Kernel
git<span class="w"> </span>checkout<span class="w"> </span>linux-msft-wsl-6.1.21.1
make<span class="w"> </span>-j<span class="w"> </span><span class="k">$(</span>nproc<span class="k">)</span><span class="w"> </span><span class="nv">KCONFIG_CONFIG</span><span class="o">=</span>Microsoft/config-wsl
cp<span class="w"> </span>arch/x86/boot/bzImage<span class="w"> </span>/mnt/c/Users/ykolerov/bzImage-6.1
</pre></div>
</div>
<p>Add this configuration to <code class="docutils literal notranslate"><span class="pre">.wslconfig</span></code>:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[wsl2]</span>
<span class="n">kernel</span><span class="o">=</span><span class="s">&quot;C:\\Users\\ykolerov\\bzImage-6.1&quot;</span>
</pre></div>
</div>
</section>
<section id="configuration-files">
<h2>Configuration Files<a class="headerlink" href="#configuration-files" title="Permalink to this heading">¶</a></h2>
<p>This is how <code class="docutils literal notranslate"><span class="pre">/etc/wsl.conf</span></code> looks like now:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[boot]</span>
<span class="n">systemd</span><span class="o">=</span><span class="kc">true</span>

<span class="k">[network]</span>
<span class="n">generateResolvConf</span><span class="o">=</span><span class="kc">false</span>
</pre></div>
</div>
<p>This is how <code class="docutils literal notranslate"><span class="pre">$env:HOMEPATH\.wslconfig</span></code> looks like now:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[wsl2]</span>
<span class="n">memory</span><span class="o">=</span><span class="mi">10</span><span class="n">GB</span>
<span class="n">kernel</span><span class="o">=</span><span class="s">&quot;C:\\Users\\ykolerov\\bzImage-6.1&quot;</span>
</pre></div>
</div>
</section>
<section id="shrink-virtual-disk-s-space">
<h2>Shrink virtual disk’s space<a class="headerlink" href="#shrink-virtual-disk-s-space" title="Permalink to this heading">¶</a></h2>
<p>Shrink virtual disk’s space when it’s necessary. Follow instructions
from <a class="reference external" href="https://stephenreescarter.net/how-to-shrink-a-wsl2-virtual-disk/">https://stephenreescarter.net/how-to-shrink-a-wsl2-virtual-disk/</a>.
Example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>PS C:\Users\ykolerov&gt; wsl --terminate Ubuntu
PS C:\Users\ykolerov&gt; diskpart

Microsoft DiskPart version 10.0.19041.964

Copyright (C) Microsoft Corporation.
On computer: SNPS-RDN8FHBSCC

DISKPART&gt; select vdisk file=&quot;C:\Users\ykolerov\AppData\Local\Packages\CanonicalGroupLimited.Ubuntu20.04onWindows_79rhkp1fndgsc\LocalState\ext4.vhdx&quot;

DiskPart successfully selected the virtual disk file.

DISKPART&gt; compact vdisk

100 percent completed

DiskPart successfully compacted the virtual disk file.
</pre></div>
</div>
<p>Sometimes it’s better to reboot laptop before doing those steps so you
can be sure that a virtual disk is note used.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">WSL</a><ul>
<li><a class="reference internal" href="#install-ubuntu">Install Ubuntu</a></li>
<li><a class="reference internal" href="#install-fedora">Install Fedora</a></li>
<li><a class="reference internal" href="#install-wsl-vpnkit">Install <code class="docutils literal notranslate"><span class="pre">wsl-vpnkit</span></code></a></li>
<li><a class="reference internal" href="#configure-wsl">Configure WSL</a></li>
<li><a class="reference internal" href="#build-and-install-the-linux-kernel-6-1">Build and Install the Linux Kernel 6.1</a></li>
<li><a class="reference internal" href="#configuration-files">Configuration Files</a></li>
<li><a class="reference internal" href="#shrink-virtual-disk-s-space">Shrink virtual disk’s space</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="linux.html"
                          title="previous chapter">Linux</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../tasks/index.html"
                          title="next chapter">Tasks</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/environment/wsl.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../tasks/index.html" title="Tasks"
             >next</a> |</li>
        <li class="right" >
          <a href="linux.html" title="Linux"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Kolerov&#39;s Notes 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Environment</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">WSL</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2023, Yuriy Kolerov.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.3.
    </div>
  </body>
</html>