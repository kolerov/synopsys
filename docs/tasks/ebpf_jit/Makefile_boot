LNXIMG  := ../linux/build/vmlinux

INSDIR  := /tools/arc-linux-gnu
QINSDIR := /tools/qemu

QEMU    := $(QINSDIR)/bin/qemu-system-arc
QPORT   := 2000
NPORT   := 2001
FTP     := hostfwd=tcp::2021-:21
SSH     := hostfwd=tcp::2022-:22
TLN     := hostfwd=tcp::2023-:23
NC      := hostfwd=tcp::$(NPORT)-:$(NPORT)
QFLAGS  := -M virt                                            \
           -nographic                                         \
           -no-reboot                                         \
           -global cpu.freq_hz=50000000                       \
           -cpu archs                                         \
           -netdev user,id=net0,$(FTP),$(SSH),$(TLN),$(NC)    \
           -device virtio-net-device,netdev=net0

GDB     := $(INSDIR)/bin/arc-elf32-gdb

.PHONY: linux gdb server clean

linux:
	$(QEMU) $(QFLAGS) -kernel $(LNXIMG)

server:
	$(QEMU) $(QFLAGS) -kernel $(LNXIMG) -S -gdb tcp::$(QPORT)

gdb:
	$(GDB) -tui                                           \
		     -q                                             \
			   -ex "add-auto-load-safe-path $(dir $(LNXIMG))" \
			   -ex "file $(LNXIMG)"                           \
			   -ex "set remotetimeout 3000"                   \
			   -ex "tar rem :$(QPORT)"                        \
			   -ex "b bpf_int_jit_compile"                    \
			   -ex "cont"

cgdb:
	cgdb -d $(GDB) --                                   \
		   -q                                             \
			 -ex "add-auto-load-safe-path $(dir $(LNXIMG))" \
			 -ex "file $(LNXIMG)"                           \
			 -ex "set remotetimeout 3000"                   \
			 -ex "tar rem :$(QPORT)"                        \
			 -ex "b bpf_int_jit_compile"                    \
			 -ex "cont"

clean:
	$(RM) *.exe *.sym gdbinit
